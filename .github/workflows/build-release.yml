name: Build TizenTube WGT

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag name (e.g., v1.0.0)'
        required: false
        type: string
      skip_release:
        description: 'Build only (skip GitHub release creation)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: write

jobs:
  build-wgt:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Build dist assets (mods + service)
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist

          cd mods
          npm ci
          npx rollup -c
          cd ..

          cd service
          npm ci
          npx rollup -c
          cd ..

          test -f dist/userScript.js
          test -f dist/service.js

      - name: Install tools for Tizen packaging
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y unzip zip curl ca-certificates openssl

      - name: Install Tizen CLI
        run: |
          set -euo pipefail
          curl -L -o /tmp/tizen-web-cli.bin https://download.tizen.org/sdk/Installer/tizen-studio_5.1/web-cli_Tizen_Studio_5.1_ubuntu-64.bin
          chmod +x /tmp/tizen-web-cli.bin
          /tmp/tizen-web-cli.bin --accept-license "$HOME/tizen-studio"
          echo "$HOME/tizen-studio/tools/ide/bin" >> "$GITHUB_PATH"

      - name: Build signed WGT
        env:
          TIZEN_CERT_PASSWORD: ${{ secrets.TIZEN_CERT_PASSWORD }}
        run: |
          set -euo pipefail
          export PATH="$HOME/tizen-studio/tools/ide/bin:$PATH"

          # Use a simple fixed password with a legacy-compatible PKCS#12 export.
          # This avoids recurring Tizen Java signer "Invaild password" failures.
          CERT_PASSWORD='tizentube-author'

          PROFILE_NAME="tizentube-ci-${GITHUB_RUN_ID:-local}"
          CERT_DIR="${HOME}/tizen-studio-data/keystore/author"
          CERT_PATH="${CERT_DIR}/${PROFILE_NAME}.p12"
          PROFILE_XML="${HOME}/tizen-studio-data/profile/profiles.xml"

          rm -rf wgt-app output
          mkdir -p wgt-app/dist output "$CERT_DIR" "$(dirname "$PROFILE_XML")"
          rm -f "$CERT_PATH"

          cp dist/userScript.js wgt-app/dist/userScript.js
          cp dist/service.js wgt-app/dist/service.js

          cat > wgt-app/index.html <<'HTML'
          <!doctype html>
          <html>
            <head><meta charset="utf-8"><title>TizenTube</title></head>
            <body><script src="./dist/userScript.js"></script></body>
          </html>
          HTML

          cat > wgt-app/config.xml <<'XML'
          <?xml version="1.0" encoding="UTF-8"?>
          <widget xmlns="http://www.w3.org/ns/widgets"
                  xmlns:tizen="http://tizen.org/ns/widgets"
                  id="http://krx3d.github.io/tizentube"
                  version="1.0.0"
                  viewmodes="maximized">
            <name>TizenTube</name>
            <content src="index.html"/>
            <feature name="http://tizen.org/feature/screen.size.normal.1080.1920"/>
            <tizen:application id="KrX3D.TizenTube" package="KrX3DTT" required_version="2.4"/>
            <tizen:profile name="tv-samsung"/>
            <icon src="icon.png"/>
          </widget>
          XML

          printf 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=' | base64 -d > wgt-app/icon.png

          openssl req -newkey rsa:2048 -nodes -x509 -days 3650             -subj "/CN=TizenTube CI/O=TizenTube"             -keyout author.key -out author.crt
          # Export using legacy algorithms for Tizen CLI Java compatibility.
          openssl pkcs12 -export -legacy -out "$CERT_PATH"             -inkey author.key -in author.crt -passout "pass:${CERT_PASSWORD}"
          rm -f author.key author.crt
          openssl pkcs12 -legacy -in "$CERT_PATH" -passin "pass:${CERT_PASSWORD}" -noout
          tizen security-profiles add -n "$PROFILE_NAME" -a "$CERT_PATH" -p "$CERT_PASSWORD"
          tizen cli-config "profiles.path=${PROFILE_XML}"
          test -f "$PROFILE_XML"
          tizen security-profiles list

          pushd wgt-app
          tizen build-web -- .
          if [ -d .buildResult ]; then
            pushd .buildResult
            tizen package -t wgt -s "$PROFILE_NAME" -- . || { echo 'Package failed, dumping Tizen CLI log'; cat "$HOME/tizen-studio-data/cli/logs/cli.log" || true; exit 1; }
            popd
          else
            tizen package -t wgt -s "$PROFILE_NAME" -- . || { echo 'Package failed, dumping Tizen CLI log'; cat "$HOME/tizen-studio-data/cli/logs/cli.log" || true; exit 1; }
          fi
          popd

          WGT_FILE=$(find wgt-app -maxdepth 2 -name '*.wgt' | head -n1)
          test -n "$WGT_FILE"
          cp "$WGT_FILE" output/TizenTube.wgt
          ls -lah output/TizenTube.wgt

      - name: Upload WGT artifact
        uses: actions/upload-artifact@v4
        with:
          name: tizentube-wgt-${{ github.run_number }}
          path: output/TizenTube.wgt
          retention-days: 30

      - name: Create Release
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.skip_release != 'true')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag_name || github.ref_name }}
          name: TizenTube Standalone ${{ github.event.inputs.tag_name || github.ref_name }}
          files: |
            output/TizenTube.wgt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
