name: Build, publish and cleanup old npm versions

on:
  push:
    branches:
      - extract_features
    paths-ignore:
      - '.github/**'
      - '.gitattributes'
      - '.gitignore'
      - '.npmignore'
      - 'LICENSE'
      - 'README.md'
      - 'package.json'
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

env:
  PACKAGE_NAME_GH: 'KrX3D/TizenTube'
  NODE_VERSION: '20'
  UNPUBLISH_WINDOW_HOURS: '72'

jobs:
  build-publish-clean:
    runs-on: ubuntu-latest
    if: >
      github.event_name != 'push' ||
      (github.actor != 'github-actions[bot]' && !contains(github.event.head_commit.message, '[skip ci]'))

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Bump root package.json version (+10 patch, rollover -> minor)
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        run: |
          set -euo pipefail
          node - <<'NODE'
          const fs = require('fs');
          const path = 'package.json';
          const pkg = JSON.parse(fs.readFileSync(path, 'utf8'));

          const ver = pkg.version || '0.0.0';
          const m = ver.match(/^(\d+)\.(\d+)\.(\d+)$/);
          if (!m) throw new Error(`Invalid version in package.json: ${ver}`);

          let major = parseInt(m[1], 10);
          let minor = parseInt(m[2], 10);
          let patch = parseInt(m[3], 10);

          patch += 10;
          if (patch >= 1000) {
            minor += 1;
            patch = 0;
          }

          const newVer = `${major}.${minor}.${patch}`;
          pkg.version = newVer;

          fs.writeFileSync(path, JSON.stringify(pkg, null, 2) + '\n', 'utf8');
          console.log(`Bumped version: ${ver} -> ${newVer}`);
          NODE

      - name: Show current version (old -> new)
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        run: |
          set -euo pipefail

          OLD_VER="$(git show HEAD^:package.json 2>/dev/null | node -e "let s='';process.stdin.on('data',d=>s+=d);process.stdin.on('end',()=>{try{console.log(JSON.parse(s).version||'');}catch{console.log('');}})")"
          NEW_VER="$(node -p "require('./package.json').version")"

          if [ -z "${OLD_VER:-}" ]; then
            echo "Version: (unknown) -> ${NEW_VER}"
          else
            echo "Version: ${OLD_VER} -> ${NEW_VER}"
          fi

      - name: Clean dist
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist

      - name: Install mods dependencies
        run: |
          set -euo pipefail
          cd mods
          npm ci

      - name: Build mods (rollup)
        run: |
          set -euo pipefail
          cd mods
          npx rollup -c

      - name: Install service dependencies
        run: |
          set -euo pipefail
          cd service
          npm ci

      - name: Build service (rollup)
        run: |
          set -euo pipefail
          cd service
          npx rollup -c

      - name: Verify dist output
        run: |
          set -euo pipefail
          echo "Listing dist/ (should contain built outputs):"
          ls -lah dist || true
          test -f dist/userScript.js
          test -f dist/service.js

      - name: Commit version bump + built files in dist/ (if changed)
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        run: |
          set -euo pipefail
          echo "Committing version bump + built files (if any changes)..."

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add package.json
          git add -f dist/userScript.js dist/service.js

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          NEWVER=$(node -p "require('./package.json').version")
          git commit -m "chore: bump version to ${NEWVER} + rebuild dist [skip ci]"

          TARGET_BRANCH="${GITHUB_REF_NAME}"
          echo "Pushing changes back to ${TARGET_BRANCH} (no rebase to avoid conflict in CI)..."
          git push origin "HEAD:${TARGET_BRANCH}"

      - name: Generate jsDelivr URLs to purge
        id: cdn_urls
        run: |
          set -euo pipefail

          BRANCH="${GITHUB_REF_NAME}"
          GH_BASE="https://cdn.jsdelivr.net/gh/${PACKAGE_NAME_GH}"

          URLS=$(printf "%s\n" \
            "${GH_BASE}@${BRANCH}" \
            "${GH_BASE}@${BRANCH}/package.json" \
            "${GH_BASE}@${BRANCH}/dist/userScript.js" \
            "${GH_BASE}@${BRANCH}/dist/service.js" \
            "${GH_BASE}/blob/${BRANCH}/package.json" \
            "${GH_BASE}/blob/${BRANCH}/dist/userScript.js" \
            "${GH_BASE}/blob/${BRANCH}/dist/service.js" \
            | paste -sd, -)

          echo "urls=${URLS}" >> "$GITHUB_OUTPUT"
          echo "Generated CDN URLs:"
          printf "%s\n" "${URLS}" | tr ',' '\n'

      - name: Purge jsDelivr cache
        if: steps.cdn_urls.outputs.urls != ''
        uses: egad13/purge-jsdelivr-cache@v1
        with:
          url: ${{ steps.cdn_urls.outputs.urls }}
          attempts: 3

      - name: Cache purge complete
        run: echo "âœ… jsDelivr cache purge complete (npm + GitHub)"
