name: Build, publish (on release) and cleanup old npm versions

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/**'
  release:
    types: [published]

env:
  PACKAGE_NAME: '@krx3d/tizentube'  # edit if needed
  NODE_VERSION: '20'
  # unpublish window in hours (npm policy ~= 72 hours)
  UNPUBLISH_WINDOW_HOURS: '72'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: https://registry.npmjs.org/

      - name: Install mods deps
        run: |
          set -euo pipefail
          cd mods
          npm ci

      - name: Build mods (rollup)
        run: |
          set -euo pipefail
          cd mods
          npx rollup -c

      - name: Install service deps
        run: |
          set -euo pipefail
          cd service
          npm ci

      - name: Build service (rollup)
        run: |
          set -euo pipefail
          cd service
          npx rollup -c

      - name: Verify dist output
        run: |
          set -euo pipefail
          ls -lh dist || true
          test -f dist/userScript.js
          test -f dist/service.js

  publish-and-clean:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: https://registry.npmjs.org/

      - name: Configure npm auth
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${NPM_TOKEN:-}" ]; then
            echo "::error::NPM_TOKEN secret is not set"
            exit 1
          fi
          printf "//registry.npmjs.org/:_authToken=%s\n" "$NPM_TOKEN" > ~/.npmrc
          printf "always-auth=true\n" >> ~/.npmrc
          echo "Wrote ~/.npmrc."

      - name: Publish package to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          npm whoami
          npm publish --access public

      - name: Wait for npm propagation after publish
        run: sleep 15

      - name: Gather versions & times from npm
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          PKG: ${{ env.PACKAGE_NAME }}
        run: |
          set -euo pipefail
          printf "//registry.npmjs.org/:_authToken=%s\n" "${NPM_TOKEN}" > ~/.npmrc
          printf "always-auth=true\n" >> ~/.npmrc

          echo "Fetching versions and publish times for ${PKG} ..."
          npm view "${PKG}" versions --json > /tmp/versions.json
          npm view "${PKG}" time --json > /tmp/time.json

          CUR_VER=$(node -e "console.log(require('./package.json').version)")
          echo "Current repo version: $CUR_VER"
          echo "CUR_VER=${CUR_VER}" > /tmp/curver.env
          
      - name: Decide which versions to process (unpublish <=72h, deprecate others)
        env:
          PKG: ${{ env.PACKAGE_NAME }}
          UNPUBLISH_WINDOW_HOURS: ${{ env.UNPUBLISH_WINDOW_HOURS }}
        run: |
          set -euo pipefail
          node -e '
          const fs = require("fs");
          const versions = JSON.parse(fs.readFileSync("/tmp/versions.json","utf8")||"[]");
          const times = JSON.parse(fs.readFileSync("/tmp/time.json","utf8")||"{}");
          const cur = fs.readFileSync("/tmp/curver.env","utf8").trim().split("=")[1];

          const windowHours = Number(process.env.UNPUBLISH_WINDOW_HOURS || "72");
          const now = Date.now();

          const arr = Array.isArray(versions) ? versions.slice() : Object.keys(versions||{});
          const items = arr.map(v => ({v, t: times[v] ? new Date(times[v]) : null}));

          items.sort((a,b) => {
            if (!a.t && !b.t) return 0;
            if (!a.t) return 1;
            if (!b.t) return -1;
            return b.t - a.t;
          });

          const candidates = items.filter(i => i.v !== cur);

          const toUnpublish = [], toDeprecate = [];
          for (const it of candidates) {
            if (!it.t) {
              toDeprecate.push(it.v);
              continue;
            }
            const ageHours = (now - it.t.getTime()) / 36e5;
            if (ageHours <= windowHours) toUnpublish.push(it.v);
            else toDeprecate.push(it.v);
          }

          fs.writeFileSync("/tmp/to_unpublish.txt", toUnpublish.join("\n"));
          fs.writeFileSync("/tmp/to_deprecate.txt", toDeprecate.join("\n"));

          console.log("To unpublish (<= " + windowHours + "h):", toUnpublish);
          console.log("To deprecate (> " + windowHours + "h or unknown):", toDeprecate);
          ' 

          echo "--- Unpublish candidates ---"
          if [ -s /tmp/to_unpublish.txt ]; then cat /tmp/to_unpublish.txt; else echo "(none)"; fi
          echo "--- Deprecate candidates ---"
          if [ -s /tmp/to_deprecate.txt ]; then cat /tmp/to_deprecate.txt; else echo "(none)"; fi

      - name: Unpublish recent versions (<=72h) with improved verification
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          PKG: ${{ env.PACKAGE_NAME }}
        run: |
          set -euo pipefail
          printf "//registry.npmjs.org/:_authToken=%s\n" "${NPM_TOKEN}" > ~/.npmrc
          printf "always-auth=true\n" >> ~/.npmrc

          # improved verification function
          verify_unpublished(){
            ver="$1"
            max_attempts=5
            attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              echo "Verification attempt $attempt/$max_attempts for ${PKG}@${ver}..."
              
              # Try to view the version - should fail if unpublished
              if npm view "${PKG}@${ver}" version 2>&1 | grep -q "npm error 404"; then
                echo "✓ Confirmed: ${PKG}@${ver} is unpublished"
                return 0
              elif npm view "${PKG}@${ver}" version >/dev/null 2>&1; then
                echo "× Still exists: ${PKG}@${ver}"
                attempt=$((attempt + 1))
                sleep 10
              else
                # Other error - assume unpublished
                echo "✓ Version check failed (likely unpublished): ${PKG}@${ver}"
                return 0
              fi
            done
            
            echo "::warning::Could not verify unpublish for ${PKG}@${ver} after ${max_attempts} attempts"
            return 1
          }

          unpublish_version(){
            ver="$1"
            max=3
            attempt=1
            
            while [ $attempt -le $max ]; do
              echo "Unpublish attempt $attempt/$max for ${PKG}@${ver}..."
              
              if npm unpublish "${PKG}@${ver}" 2>&1 | tee /tmp/unpublish_${ver}.log; then
                echo "npm unpublish command completed for ${PKG}@${ver}"
                
                # Wait longer for npm propagation
                echo "Waiting 20 seconds for npm registry propagation..."
                sleep 20
                
                # Verify it's actually gone
                if verify_unpublished "$ver"; then
                  echo "✓ Successfully unpublished and verified: ${PKG}@${ver}"
                  return 0
                else
                  echo "::warning::Unpublish command succeeded but version still visible"
                fi
              else
                echo "::warning::npm unpublish command failed for ${PKG}@${ver}"
              fi
              
              attempt=$((attempt + 1))
              sleep 5
            done
            
            return 1
          }

          # Process unpublish candidates
          if [ -s /tmp/to_unpublish.txt ]; then
            echo "Processing versions to unpublish..."
            while IFS= read -r ver; do
              [ -z "$ver" ] && continue
              echo ""
              echo "========================================="
              echo "Processing: ${PKG}@${ver}"
              echo "========================================="
              
              if unpublish_version "$ver"; then
                echo "✓ ${PKG}@${ver} successfully removed"
              else
                echo "::warning::Failed to unpublish ${PKG}@${ver} - will try to deprecate instead"
                # Fall back to deprecate
                if npm deprecate "${PKG}@${ver}" "Deprecated - please upgrade to latest version." 2>&1; then
                  echo "✓ Deprecated ${PKG}@${ver} as fallback"
                else
                  echo "::error::Both unpublish and deprecate failed for ${PKG}@${ver}"
                fi
              fi
            done < /tmp/to_unpublish.txt
          else
            echo "No recent versions to unpublish."
          fi

      - name: Deprecate older versions (>72h)
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          PKG: ${{ env.PACKAGE_NAME }}
        run: |
          set -euo pipefail
          printf "//registry.npmjs.org/:_authToken=%s\n" "${NPM_TOKEN}" > ~/.npmrc
          printf "always-auth=true\n" >> ~/.npmrc

          if [ -s /tmp/to_deprecate.txt ]; then
            echo "Deprecating older versions..."
            while IFS= read -r ver; do
              [ -z "$ver" ] && continue
              echo "Deprecating ${PKG}@${ver}..."
              if npm deprecate "${PKG}@${ver}" "Deprecated - please upgrade to latest version." 2>&1; then
                echo "✓ Successfully deprecated ${PKG}@${ver}"
              else
                echo "::warning::Failed to deprecate ${PKG}@${ver}"
              fi
            done < /tmp/to_deprecate.txt
          else
            echo "No older versions to deprecate."
          fi

      - name: Final verification
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          PKG: ${{ env.PACKAGE_NAME }}
        run: |
          set -euo pipefail
          printf "//registry.npmjs.org/:_authToken=%s\n" "${NPM_TOKEN}" > ~/.npmrc
          printf "always-auth=true\n" >> ~/.npmrc
          
          echo "Waiting 10 seconds before final check..."
          sleep 10
          
          echo "Final versions list:"
          npm view "${PKG}" versions --json || true
          
          echo ""
          echo "Latest version:"
          npm view "${PKG}" version || true

      - name: Purge jsDelivr cache
        run: |
          set -euo pipefail
          echo "Purging jsDelivr cache for ${PACKAGE_NAME}..."
          curl -i "https://purge.jsdelivr.net/npm/${PACKAGE_NAME}@latest/package.json" || true
          curl -i "https://purge.jsdelivr.net/npm/${PACKAGE_NAME}@*/package.json" || true
          curl -i "https://purge.jsdelivr.net/npm/${PACKAGE_NAME}/package.json" || true
          curl -i "https://purge.jsdelivr.net/npm/${PACKAGE_NAME}@*" || true

      - name: Done
        run: echo "✓ Publish + cleanup complete."